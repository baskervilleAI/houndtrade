<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Test Velas Japonesas - CDN</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        .chart-container {
            width: 600px;
            height: 400px;
            background: #111;
            border: 2px solid #333;
            margin: 20px 0;
        }
        #status {
            background: #222;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            background: #333;
            color: #fff;
            border: none;
            padding: 8px 12px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <h1>🕯️ Test Velas Japonesas - CDN</h1>
    
    <div id="status">
        <div id="log">⏳ Cargando Chart.js desde CDN...</div>
    </div>

    <div class="controls">
        <button onclick="testCandlestickChart()">🕯️ Test Velas Japonesas</button>
        <button onclick="clearStatus()">🧹 Limpiar Log</button>
    </div>

    <div class="chart-container">
        <canvas id="chart" width="600" height="400"></canvas>
    </div>

    <!-- CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        const log = document.getElementById('log');
        let currentChart = null;
        
        function updateLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += '<br>[' + timestamp + '] ' + message;
            console.log(message);
            log.scrollTop = log.scrollHeight;
        }
        
        function clearStatus() {
            log.innerHTML = '🧹 Log limpiado';
        }
        
        // Datos de velas japonesas
        const candleData = [
            { x: new Date('2025-09-22T10:00:00Z').getTime(), o: 112000, h: 112500, l: 111800, c: 112300 },
            { x: new Date('2025-09-22T11:00:00Z').getTime(), o: 112300, h: 112800, l: 112100, c: 112600 },
            { x: new Date('2025-09-22T12:00:00Z').getTime(), o: 112600, h: 112900, l: 112400, c: 112200 },
            { x: new Date('2025-09-22T13:00:00Z').getTime(), o: 112200, h: 112700, l: 111900, c: 112500 },
            { x: new Date('2025-09-22T14:00:00Z').getTime(), o: 112500, h: 113000, l: 112300, c: 112800 },
            { x: new Date('2025-09-22T15:00:00Z').getTime(), o: 112800, h: 113200, l: 112600, c: 112900 },
            { x: new Date('2025-09-22T16:00:00Z').getTime(), o: 112900, h: 113100, l: 112500, c: 112700 },
            { x: new Date('2025-09-22T17:00:00Z').getTime(), o: 112700, h: 113000, l: 112400, c: 112850 },
        ];
        
        function testCandlestickChart() {
            updateLog('🕯️ Iniciando test de velas japonesas con CDN...');
            
            if (typeof Chart === 'undefined') {
                updateLog('❌ Chart.js no está disponible');
                return;
            }
            
            if (typeof ChartFinancial === 'undefined') {
                updateLog('❌ Chart.js Financial no está disponible');
                return;
            }
            
            try {
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                
                updateLog('🔧 Registrando componentes...');
                Chart.register(
                    ChartFinancial.CandlestickController,
                    ChartFinancial.CandlestickElement,
                    ChartFinancial.OhlcController,
                    ChartFinancial.OhlcElement
                );
                
                const ctx = document.getElementById('chart').getContext('2d');
                
                updateLog('📊 Creando gráfico...');
                
                currentChart = new Chart(ctx, {
                    type: 'candlestick',
                    data: {
                        datasets: [{
                            label: 'BTC/USDT',
                            data: candleData,
                            borderColor: {
                                up: '#00ff88',
                                down: '#ff4444',
                                unchanged: '#999999',
                            },
                            backgroundColor: {
                                up: 'rgba(0, 255, 136, 0.1)',
                                down: 'rgba(255, 68, 68, 0.1)',
                                unchanged: 'rgba(153, 153, 153, 0.1)',
                            },
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    displayFormats: {
                                        hour: 'HH:mm'
                                    }
                                },
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y: {
                                position: 'right',
                                ticks: { 
                                    color: '#fff',
                                    callback: function(value) {
                                        return '$' + (value/1000).toFixed(1) + 'k';
                                    }
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '🕯️ Velas Japonesas CDN',
                                color: '#fff'
                            },
                            legend: {
                                labels: { color: '#fff' }
                            }
                        }
                    }
                });
                
                updateLog('✅ ¡Gráfico CDN creado exitosamente!');
                
            } catch (error) {
                updateLog('❌ Error: ' + error.message);
                console.error(error);
            }
        }
        
        // Auto-verificar cuando cargue
        window.addEventListener('load', function() {
            setTimeout(() => {
                updateLog('🔍 Chart.js: ' + (typeof Chart !== 'undefined' ? '✅' : '❌'));
                updateLog('🔍 ChartFinancial: ' + (typeof ChartFinancial !== 'undefined' ? '✅' : '❌'));
                
                if (typeof Chart !== 'undefined' && typeof ChartFinancial !== 'undefined') {
                    testCandlestickChart();
                }
            }, 1000);
        });
    </script>
</body>
</html>
